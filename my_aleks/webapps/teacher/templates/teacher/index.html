{% extends base_template %}

{% load staticfiles %}

{% block "main_content" %}
    <div>
           <!-- Page Heading -->
		   <div class="app-title">
			   <h4 class="h4">学情报告</h4>
		   </div>
			<div class="row">
                <!--级联选择框 -->
                {% if  base_template == 'teacher/teacher_base.html' %}
                <div class="col-lg-12">
					<div class="tile">
                        <div class="tile-body flex-row">

                       		<!-- <div class="btn-group" style="float:left;position: relative">

    						   <input type="text" style="text-align: left;width: 200px;float:left" readonly="readonly" disabled class="form-control" id="classInput" placeholder="请选择班级">
                        	   <div class="input-group-btn">
                                    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                                            aria-haspopup="true" aria-expanded="false">选择班级 <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                        {% for schoolClass in classes %}
                                        <li class="classCheckLi">
                                            <div class="dropdown-item" style="cursor:hand" name="{{schoolClass.id}}">{{schoolClass.name}}</div>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div> -->

                            <div style="float:left"  class="input-group-btn">   
                                <input type="text" placeholder="请选择班级" class="form-control" data-toggle="dropdown"aria-haspopup="true" aria-expanded="false" style="text-align: left;width:160px;height:40px" readonly="readonly" id="classInput" >
                                <ul class="dropdown-menu dropdown-menu-left">
                                    <li class="classCheckLi" id="select">
                                        {% for schoolClass in classes %}
                                            <div class="dropdown-item" style="cursor:hand" name="{{schoolClass.id}}">{{schoolClass.name}}</div>
                                        {% endfor %}
                                    </li>
                                </ul>
                            </div>

                            <div class="btn btn-info btn-icon-split btn-sm" style="margin-left: 10px" id="checkButton">
                                <span class="text" id="query_learning" name="checkStudyState">查询学情状况</span>
                            </div>
                        </div>
				    </div>
                    <!--<button id="testButton">查询报告</button>-->
                </div>
                {% endif %}
			</div>
              {% if LearningInformation.performance %}
                <!-- Content Row -->
                <div class="row">
                        <!-- Earnings (Monthly) Card Example -->
                        <div class="col-lg-4 col-md-4 mb-4">
                            <div class="card border-left-primary shadow">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                最近一次考试最高分
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                {{LearningInformation.performance.topScore}}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Earnings (Monthly) Card Example -->
                        <div class="col-lg-4 col-md-4 mb-4">
                            <div class="card border-left-success shadow">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                最近一次考试最低分
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                {{LearningInformation.performance.lowestScore}}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Requests Card Example -->
                        <div class="col-lg-4 col-md-4 mb-4">
                            <div class="card border-left-warning shadow">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                最近一次考试平均分
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                {{LearningInformation.performance.averageScore}}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-comments fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <div class="col-lg-12 mb-4">
                        <div class="card shadow">
                            <div class="card-header border-bottom">
                                <h6 class="font-weight-bold text-primary">班级学情报告列表</h6>
                                <div id="myTableButton">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" width="100%" cellspacing="0">
                                        <thead>
                                        <tr>
                                            <th>报告名</th>
                                            <th>打开</th>
                                            <th>生成PDF文档</th>
                                        </tr>
                                        </thead>
                                        <tbody  id="myTBody">
                                        </tbody>
                                    </table>
                                    <ul class="pagination" style="float: right">
                                        <li class="paginate_button page-item previous" id="dataTable_previous">
                                            <a href="#" aria-controls="dataTable" id="classPapePrev" class="page-link">前一页</a>
                                        </li>
                                        <li class="paginate_button page-item next" id="dataTable_next">
                                            <a href="#" aria-controls="dataTable" id="classPapeNext"  class="page-link">下一页</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
			    <!--                </div>-->

        {% if studentProfile %}
        <div class="row">
            <!-- Content Column -->
            <div class="col-lg-6">
                <!-- DataTales Example -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">学生信息</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table  cellpadding="0" cellspacing="0">
                                <tr>
                                    <td width="260" border="1" valign="top">
                                        <table >
                                            <tr height="10">
                                                <td></td>
                                                <td></td>
                                            </tr>
                                            <tr>

                                                <td width="230" align="right">
                                                    {% if studentProfile.profile.image %}
                                                    <img id="imgUpdate" class="img-profile rounded-circle" src="{{studentProfile.profile.image}}" style="height: 200px;width:200px">
                                                    {% else %}
                                                    <img id="imgUpDown" class="img-profile rounded-circle" src="{% static 'assets/img/user.jpg' %}" style="height: 200px">
                                                    {% endif %}
                                                </td>

                                                <td width="30">

                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                    <td width="30"></td>

                                    <td  valign="top">
                                        <table border="0" cellpadding="0" cellspacing="0" >
                                            <tr height="15">
                                                <td align="right">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="2">
                                                    <span style="font-weight:bold;">学生信息</span>&nbsp;&nbsp;
                                                </td>
                                            </tr>
                                            <tr>
                                            <tr height="10"><td></td></tr>
                                            <td width="50%">姓名 : <span style="color: #000000">{{studentProfile.profile.name}}</span></td>
                                            </tr>
                                            <tr>
                                            <tr height="10"><td></td></tr>
                                            <td width="50%">年龄 : <span style="color: #000000">{{studentProfile.profile.age}}</span></td>
                                            </tr>

                                            <tr>
                                            <tr height="10"><td></td></tr>
                                            <td width="50%">电话号码 : <span style="color: #000000">{{studentProfile.profile.phone}}</span></td>
                                            </tr>

                                            <tr>
                                            <tr height="10"><td></td></tr>
                                            <td width="50%">学号 : <span style="color: #000000">{{studentProfile.profile.student_no}}</span></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <!-- DataTales Example -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <div class="m-0 font-weight-bold text-primary" style="display: inline-block;padding-top: 6px">家长信息</div>
                        <div style="float: right" class="btn btn-info btn-icon-split btn-sm">
                            <span class="text" id="addParent"  studentId="{{studentProfile.profile.id}}">添加家长</span>
                        </div>
                    </div>
                    <div class="card-body" style="height: 230px">
                        <div class="table-responsive">
                            <table>
                                <tr height="15">
                                    <td align="right">
                                    </td>
                                </tr>
                                <tr>
                                    <td width="100px">
                                        <span style="font-weight:bold;" >家长姓名</span>&nbsp;&nbsp;
                                    </td>
                                    <td width="100px">
                                        <span style="font-weight:bold;" >关系</span>&nbsp;&nbsp;
                                    </td>
                                    <td width="150px">
                                        <span style="font-weight:bold;" >联系电话</span>&nbsp;&nbsp;
                                    </td>
                                    <td width="100px">
                                        <span style="font-weight:bold" >操作</span>&nbsp;&nbsp;
                                    </td>
                                </tr>

                                {% for parent in studentProfile.parentList %}
                                <tr height="10"><td></td></tr>
                                <tr>
                                    <td width="100px" id="parentName{{parent.id}}">{{parent.name}}</td>
                                    <td width="100px" id="parentInfo{{parent.id}}">{{parent.info}}</td>
                                    <td width="150px" id="parentPhone{{parent.id}}">{{parent.phone}}</td>
                                    <td width="100px"><span style="color:#009688;cursor: pointer;" parentId="{{parent.id}}" class="updateParent">修改信息</span></td>
                                </tr>
                                {% endfor %}


                            </table>

                        </div>
                    </div>
                </div>
            </div>


        </div>
        {% endif %}










                <!-- Content Row -->

                <div class="row">

                    {% if LearningInformation.performance or LearningInformation.reportList %}
                    <!-- Area Chart -->
                    <div class="col-xl-8 col-lg-7">
                        <div class="card shadow mb-4">
                            <!-- Card Header - Dropdown -->
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">测试情况</h6>
                                <div class="dropdown no-arrow">
                                    <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                       <!-- <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>-->
                                    </a>

                                </div>
                            </div>
                            <!-- Card Body -->
                            <div class="card-body">
                                <div class="chart-area">
                                    <canvas id="myAreaChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                   {% endif %}

                    <!-- Pie Chart -->
                    {% if LearningInformation.performance or LearningInformation.reportList %}
                    <div class="col-xl-4 col-lg-5">
                        <div class="card shadow mb-4" style="height:411px">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">弱点知识统计</h6>
                            </div>
                            <div class="card-body" id="weaknessListBody">
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if LearningInformation.reportList or LearningInformation.studentList %}
                <!-- Content Row -->
                <div class="row">
                    <!-- Content Column -->
                    <div class="col-lg-12">
                        <!-- DataTales Example -->
                        <div class="card shadow mb-4">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold text-primary">学生学情报告列表</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                        {% if LearningInformation.reportList %}
                                        <thead>
                                        <tr>
                                            <th>报告名</th>
                                            <th>生成时间</th>
                                            <th>打开</th>
                                            <th>生成PDF文档</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for report in LearningInformation.reportList %}
                                        <tr>
                                            <td>{{report.pdf_uri|cut:".pdf"}}   </td>
                                            <td>{{report.datetime}}</td>
                                            <td class="tdOnReport">
                                                <div class="btn btn-info btn-sm">
                                                    <span class="text" name="{{report.pdf_uri|cut:".pdf"}}">查看报告</span>
                                                </div>
                                            </td>
                                            <td class="tdOnDownload">
                                                <div class="btn btn-info btn-icon-split btn-sm">
                                                    <span class="text" name="{{report.pdf_uri|cut:".pdf"}}">导出PDF文件</span>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                        {% endif %}
                                        <!--根据对象不同展示不同数据 -->
                                        {% if LearningInformation.studentList %}
                                        <thead>
                                        <tr>
                                            <th>学生学号</th>
                                            <th>学生姓名</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for student in LearningInformation.studentList %}
                                        <tr>
                                            <td>{{student.student_no}}</td>
                                            <td>{{student.name}}</td>
                                            <td class="tdOnStudent">
                                                {% if student.is_join %}
                                                <div class="btn btn-info btn-icon-split btn-sm">
                                                    <span class="text" name="{{student.id}}">查看学情报表</span>
                                                </div>
                                                {% else %}
                                                <div >
                                                    <span >未参加</span>
                                                </div>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        </tbody>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
				</div>
    </div>
{% endblock %}

{% block "scripts" %}
  <!-- Page level plugins -->
  <script src="{% static "assets/vendor/chart.js/Chart.min.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/vendor/bootstrap/js/bootstrap.bundle.min.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/vendor/jquery-easing/jquery.easing.min.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/js/sb-admin-2.min.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/vendor/datatables/jquery.dataTables.min.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/vendor/datatables/dataTables.bootstrap4.min.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/js/demo/datatables-demo.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/vendor/teacherReport/jquerysession.js" %}" type="text/javascript"></script>
  <script src="{% static "assets/vendor/teacherReport/statement.js" %}" type="text/javascript"></script>
<script src="{% static "assets/js/jquery.addParentbox.js" %}" type="text/javascript"></script>

	<script type="text/javascript">

        var hasNext = false;
        var classPage = 1;

        //添加家长信息
        $('#addParent').click(function () {
            var student_id = $(this).attr('studentId');
            console.info(student_id)
            $.AddClsMsgBox.Confirm("添加信息",function () {
                var name = $("input[name='name']").val();
                var phone = $("input[name='phone']").val();
                var info = $("input[name='info']").val();
                $.post("{% url 'update-parent' %}",{
                    'student_id':student_id,
                    'name':name,
                    'phone':phone,
                    'info':info
                },function(data,status){
                    if (status != "success"){
                        alert("添加失败！");
                    } else {
                        if (data=='OK'){
                            alert("添加成功！");
                            window.location.reload();
                        } else {
                            alert("添加失败！");
                        }
                    }
                });
            },[]);
        });
        //修改家长信息
        $('.updateParent').click(function () {
            var parent_id = $(this).attr('parentId');
            var name1 = '#parentName'+parent_id;
            name1 = $(name1).text();
            var phone1 = '#parentPhone'+parent_id;
            phone1 = $(phone1).text();
            var info1 = '#parentInfo'+parent_id;
            info1 = $(info1).text();
            $.AddClsMsgBox.Confirm("修改信息",function () {
                var name = $("input[name='name']").val();
                var phone = $("input[name='phone']").val();
                var info = $("input[name='info']").val();
                $.post("{% url 'update-parent' %}", {
                    'parent_id': parent_id,
                    'name': name,
                    'phone': phone,
                    'info': info
                },function(data,status){
                    if (status != "success"){
                        alert("添加失败！");
                    } else {
                        if (data=='OK'){
                            alert("添加成功！");
                            window.location.reload();
                        } else {
                            alert("添加失败！");
                        }
                    }
                });
            },[name1,phone1,info1]);
        });
        //获取该学生的知识弱点
        var getKnowledgeList = function (studentId){
        //获取学生最近学习的知识id
        var graphId = 'ac32709e67ff';
        $.get("{% url 'get-student-graph-vector' %}"+"?student_id="+studentId+"&graph_id="+graphId,function(data,status){
            var jsonData = JSON.parse(data);
            var array = [];
            for(var key in jsonData) {
                var scoreItem = parseInt(jsonData[key]['score'] * 100);
                if(scoreItem != 60){
                    jsonData[key]['score'] = scoreItem;
                    jsonData[key]['name']=key;
                    array.push(jsonData[key]);
                }

            }
            array.sort(sortFun);
            var nodeList = [];
            if(array.length == 0){
                $('#weaknessListBody').html('<div style="padding-top:200px;padding: 15px;text-align:center">缺少测试数据，无法查询弱点知识</div>');
                return;
            }
            if(array.length >= 5 ){
                nodeList = array.slice(0,5)
            }else{
                nodeList = array.slice(0,array.length);
            }
            $.post("{% url 'get-node-chineseName' %}",JSON.stringify(nodeList),function(data,status){
                if(data){
                    var dataJson = JSON.parse(data);
                    var htmlString = "";
                    console.info(dataJson)
                    for(var item in dataJson){
                        console.info(dataJson[item])
                        htmlString += '<h4 class="small font-weight-bold">'+dataJson[item].chinese_name+'<span class="float-right">'+dataJson[item].score+'%</span>\n' +
                            '                                </h4>\n' +
                            '                                <div class="progress mb-4">\n' +
                            '                                    <div class="progress-bar bg-danger" role="progressbar"\n' +
                            '                                         style="width: '+dataJson[item].score+'%" aria-valuenow="'+dataJson[item].score+'"\n' +
                            '                                         aria-valuemin="0" aria-valuemax="100"></div>\n' +
                            '                                </div>';
                    }
                }else{
                    alert("转换错误");
                }
                    $('#weaknessListBody').html(htmlString);
            })
        })
    };
    //获取班级知识弱点
    var getClassKnowledgeList = function (clsId){
        //获取班级最近学习的知识id
        var graphId = 'ac32709e67ff';
        $.get("{% url 'get-cls-graph-vector' %}"+"?cls_id="+clsId+"&graph_id="+graphId,function(data,status){
            var jsonData = JSON.parse(data);
            var array = [];
            for(var key in jsonData) {
                var item = {score:'',name:''};
                var scoreItem = parseInt(jsonData[key] * 100);
                if(scoreItem != 60){
                    item['score'] = scoreItem
                    item['name']=key;
                    array.push(item);
                }
            }
            array.sort(sortFun);
            var nodeList = [];
            if(array.length == 0){
                $('#weaknessListBody').html('<div style="padding-top:200px;padding: 15px;text-align:center">缺少测试数据，无法查询弱点知识</div>');
                return;
            }
            if(array.length >= 5 ){
                nodeList = array.slice(0,5)
            }else{
                nodeList = array.slice(0,array.length);
            }
            $.post("{% url 'get-node-chineseName' %}",JSON.stringify(nodeList),function(data,status){
                if(data){
                    var dataJson = JSON.parse(data);
                    var htmlString = "";
                    for(var item in dataJson){
                        htmlString += '<h4 class="small font-weight-bold">'+dataJson[item].chinese_name+'<span class="float-right">'+dataJson[item].score+'%</span>\n' +
                            '                                </h4>\n' +
                            '                                <div class="progress mb-4">\n' +
                            '                                    <div class="progress-bar bg-danger" role="progressbar"\n' +
                            '                                         style="width: '+dataJson[item].score+'%" aria-valuenow="'+dataJson[item].score+'"\n' +
                            '                                         aria-valuemin="0" aria-valuemax="100"></div>\n' +
                            '                                </div>';
                    }
                }else{
                    alert("转换错误");
                }
                $('#weaknessListBody').html(htmlString);
            })
        })
    };

    //排序方法
    var sortFun = function(a,b){
        return a.score - b.score;
    };

        //获取班级学情报告每一页数据
        var getClassReportByClassId = function(classId,page,size){
            $.post("{% url "ajax-get-class-report-by-class-id" %}",JSON.stringify({
                'classId':classId,
                'page':page,
                'size':size,
            }),function(data,status){
                var htmlString = '';
                var json = JSON.parse(data)
                for(var i in json.quiz_record){
                    var name = json.quiz_record[i].pdf_uri.split('.')[0];
                    htmlString +='<tr><td>'+name+'</td><td class="tdOnReport"><div class="btn btn-primary btn-sm"> <span class="text" name="'+name+'">查看报告</span></div></td><td class="tdOnDownload"><div class="btn btn-info btn-sm"><span class="text" name="'+name+'">导出PDF文件</span></div></td></tr>'
                }
                hasNext = json.hasNext;
                $('#myTBody').html(htmlString);
                $.session.set("page",page);
            });
        };

        //跳转到班级学情报告上一页
        $(document).on('click','#classPapePrev',function(){
            if(classPage > 1){
                classPage = classPage - 1;
                var classId = $.session.get("classId");
                getClassReportByClassId(classId,classPage,4);
            }else{
                alert('已到首页');
            }

        });
        //跳转到下一页
        $(document).on('click','#classPapeNext',function(){
            if(hasNext){
                classPage = classPage + 1;
                var classId = $.session.get("classId");
                getClassReportByClassId(classId,classPage,4);
            }else{
                alert("已到尾页");
            }

        });
    //获取url参数
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return (false);
    }
        //每次加载页面完成后执行
        $(document).ready(function () {
            var divBox = document.getElementById("myTBody");
            var classId = getQueryVariable("classId");
            var studentId = getQueryVariable("studentId");
            if(divBox){
                console.info("开始")
                getClassDrawData(classId);
                getClassReportByClassId(classId,classPage,4);
                getClassKnowledgeList(classId);
            }else{
                if(studentId){
                    getStudentDrawData(classId,studentId);
                    getKnowledgeList(studentId);
                }
            }
        })
    //查看报告
    //$('.tdOnReport .text').on('click',function (){
    $(document).on('click','.tdOnReport .text',function(){
        var name = $(this).attr("name");
        var url = '{{TEMPLATES_IP}}/templates-static/templates/html/'+name+'.html'
        window.open(url);
    });

    //下载pdf文档
    //$('.tdOnDownload .text').on('click',function (){
    $(document).on('click','.tdOnDownload .text',function(){    
        var name=$(this).attr("name");
        var url = '{{TEMPLATES_IP}}/templates-static/templates/pdf/'+name+'.pdf';
        window.open(url);
    });
    //选择班级点击事件
     $(document).on('click','.dropdown-item',function(){
        var id = $(this).attr('name')
        var name = $(this).text()
        //console.log(id)
        //console.log(name)
        $("#classInput").attr('name',id)
        $("#classInput").val(name)
     })
	</script>

    <script type="text/javascript">



    </script>



{% endblock %}
